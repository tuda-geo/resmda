
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Geothermal Case Study &#8212; dageo 1.1.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css?v=6343382a" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../_static/documentation_options.js?v=2a705162"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'gallery/geothermal';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Localization" href="localization.html" />
    <link rel="prev" title="2D Fluvial Reservoir ESMDA example" href="fluvialreservoir.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="1.1.0" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">dageo</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../manual/index.html">
    User Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Gallery
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/index.html">
    API reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/tuda-geo/dageo" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../manual/index.html">
    User Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Gallery
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/index.html">
    API reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/tuda-geo/dageo" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="basicESMDA.html">Linear and non-linear ESMDA examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="basicreservoir.html">2D Reservoir ESMDA example</a></li>
<li class="toctree-l1"><a class="reference internal" href="fluvialreservoir.html">2D Fluvial Reservoir ESMDA example</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Geothermal Case Study</a></li>
<li class="toctree-l1"><a class="reference internal" href="localization.html">Localization</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Gallery</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Geothermal Case Study</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-gallery-geothermal-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="geothermal-case-study">
<span id="sphx-glr-gallery-geothermal-py"></span><h1>Geothermal Case Study<a class="headerlink" href="#geothermal-case-study" title="Link to this heading">#</a></h1>
<p>ESMDA example predicting temperature at a production well as a function of
permeability.</p>
<p>This example demonstrates the application of the Ensemble Smoother with
Multiple Data Assimilation (ESMDA) using the <code class="docutils literal notranslate"><span class="pre">dageo</span></code> library to predict
temperature at a production well in a geothermal reservoir. The notebook
integrates the <a class="reference external" href="https://darts.citg.tudelft.nl">Delft Advanced Research Terra Simulator (DARTS)</a> to model the impact of permeability
variations on temperature over a 30-year period. The example uses a channelized
permeability field, which provides an interesting case study of ESMDA’s
behavior with non-Gaussian geological features. Since ESMDA operates under
Gaussian assumptions, it tends to create smooth updates to the permeability
field rather than maintaining sharp channel boundaries. This limitation becomes
particularly visible when the algorithm identifies the need for connectivity
between wells - instead of creating or modifying channels, it increases
permeability in a more diffuse manner. This behavior highlights both the power
of ESMDA in matching production data and its limitations in preserving complex
geological features.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>This example can serve as an example how one can use <code class="docutils literal notranslate"><span class="pre">dageo</span></code> with any
external modelling code, here with the <em>Delft Advanced Research Terra
Simulator</em> (DARTS).</p>
<p><strong>Thanks to Mona Devos, who provided the initial version of this example!</strong></p>
</div>
<section id="pre-computed-data">
<h2>Pre-computed data<a class="headerlink" href="#pre-computed-data" title="Link to this heading">#</a></h2>
<section id="darts-computation">
<h3>DARTS computation<a class="headerlink" href="#darts-computation" title="Link to this heading">#</a></h3>
<p>The DARTS computation in this example takes too long for it to be run
automatically on GitHub with every commit for the documentation (CI). We
therefore pre-computed the results locally to show them here. You can change
the flag <code class="docutils literal notranslate"><span class="pre">compute_darts</span></code> from <code class="docutils literal notranslate"><span class="pre">False</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> to actually compute the
results with DARTS yourself. The pre-computed results were generated with the
following versions (taking roughly 4 h on a single thread):</p>
<ul class="simple">
<li><p>open-darts: 1.1.4</p></li>
<li><p>Python: 3.10.15</p></li>
<li><p>NumPy: 2.0.2</p></li>
<li><p>SciPy: 1.14.1</p></li>
</ul>
</section>
<section id="fluvial-models">
<h3>Fluvial models<a class="headerlink" href="#fluvial-models" title="Link to this heading">#</a></h3>
<p>The fluvial models were generated with <code class="docutils literal notranslate"><span class="pre">FLUVSIM</span></code> through <code class="docutils literal notranslate"><span class="pre">geomodpy</span></code>, for
more information see towards the end of the example where the code is shown to
reproduce the facies.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>To retrieve the pre-computed data (for both DARTS and the facies), you need
to have <code class="docutils literal notranslate"><span class="pre">pooch</span></code> installed:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>pooch
</pre></div>
</div>
<p>or</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>install<span class="w"> </span>-c<span class="w"> </span>conda-forge<span class="w"> </span>pooch
</pre></div>
</div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pooch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">dageo</span>

<span class="n">compute_darts</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">compute_darts</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">darts.engines</span> <span class="kn">import</span> <span class="n">redirect_darts_output</span>
    <span class="kn">from</span> <span class="nn">darts.models.darts_model</span> <span class="kn">import</span> <span class="n">DartsModel</span>
    <span class="kn">from</span> <span class="nn">darts.physics.geothermal.physics</span> <span class="kn">import</span> <span class="n">Geothermal</span>
    <span class="kn">from</span> <span class="nn">darts.reservoirs.struct_reservoir</span> <span class="kn">import</span> <span class="n">StructReservoir</span>
    <span class="kn">from</span> <span class="nn">darts.physics.geothermal.property_container</span> <span class="kn">import</span> <span class="n">PropertyContainer</span>

    <span class="n">redirect_darts_output</span><span class="p">(</span><span class="s2">&quot;run_geothermal.log&quot;</span><span class="p">)</span>

    <span class="c1"># For reproducibility, we instantiate a random number generator with a</span>
    <span class="c1"># fixed seed. For production, remove the seed!</span>
    <span class="n">rng</span> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/random/generator.html#numpy.random.default_rng" title="numpy.random.default_rng" class="sphx-glr-backref-module-numpy-random sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span></a><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="load-pre-computed-data">
<h2>Load pre-computed data<a class="headerlink" href="#load-pre-computed-data" title="Link to this heading">#</a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">folder</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>
<span class="n">ffacies</span> <span class="o">=</span> <span class="s2">&quot;facies_geothermal.npy&quot;</span>
<span class="n">fdarts</span> <span class="o">=</span> <span class="s2">&quot;darts_output_geothermal.npz&quot;</span>

<span class="c1"># Load Facies: Not needed if you compute the facies yourself,</span>
<span class="c1">#              as described at the end of the notebook.</span>
<span class="n">fpfacies</span> <span class="o">=</span> <span class="n">pooch</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
    <span class="s2">&quot;https://raw.github.com/tuda-geo/data/2024-11-30/resmda/&quot;</span><span class="o">+</span><span class="n">ffacies</span><span class="p">,</span>
    <span class="s2">&quot;9b18f1c80aea93d7973effafde001aa7e72a21ac91edf08e3899d5486998ad2e&quot;</span><span class="p">,</span>
    <span class="n">fname</span><span class="o">=</span><span class="n">ffacies</span><span class="p">,</span>
    <span class="n">path</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span>
<span class="p">)</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">facies</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.load.html#numpy.load" title="numpy.load" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">load</span></a><span class="p">(</span><span class="n">fpfacies</span><span class="p">)</span>

<span class="c1"># Load pre-computed DARTS result; only needed if `compute_darts=False`.</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">compute_darts</span><span class="p">:</span>
    <span class="n">fpdarts</span> <span class="o">=</span> <span class="n">pooch</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
        <span class="s2">&quot;https://raw.github.com/tuda-geo/data/2024-11-30/resmda/&quot;</span><span class="o">+</span><span class="n">fdarts</span><span class="p">,</span>
        <span class="s2">&quot;5622729cd5dc7214de8a199512ace39bda48bff113b2eddb0c48593a57c020d1&quot;</span><span class="p">,</span>
        <span class="n">fname</span><span class="o">=</span><span class="n">fdarts</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span>
    <span class="p">)</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.lib.npyio.NpzFile.html#numpy.lib.npyio.NpzFile" title="numpy.lib.npyio.NpzFile" class="sphx-glr-backref-module-numpy-lib-npyio sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">pc_darts</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.load.html#numpy.load" title="numpy.load" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">load</span></a><span class="p">(</span><span class="n">fpdarts</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="convert-facies-to-permeability">
<h2>Convert facies to permeability<a class="headerlink" href="#convert-facies-to-permeability" title="Link to this heading">#</a></h2>
<p>Here we define some model parameters. Important: These have obviously to
agree with the facies you computed!</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Model parameters</span>
<span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">3</span>   <span class="c1"># 60 x 60 x 3 cells</span>
<span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span>  <span class="c1"># Each cell is a voxel of 30 x 30 x 30 meter</span>
<span class="n">ne</span> <span class="o">=</span> <span class="mi">100</span>                 <span class="c1"># 100 ensembles</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">years</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.arange.html#numpy.arange" title="numpy.arange" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">arange</span></a><span class="p">(</span><span class="mi">31</span><span class="p">)</span>    <span class="c1"># Time: we are modelling 30 years:</span>

<span class="c1"># Well locations</span>
<span class="n">iw</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>
<span class="n">jw</span> <span class="o">=</span> <span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">46</span><span class="p">]</span>

<span class="c1"># Minimum and maximum values for permeability</span>
<span class="n">perm_min</span> <span class="o">=</span> <span class="mf">100.</span>
<span class="n">perm_max</span> <span class="o">=</span> <span class="mf">200.</span>

<span class="c1"># Get permeability fields by populating the facies</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.zeros.html#numpy.zeros" title="numpy.zeros" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">zeros</span></a><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">facies</span></a><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a><span class="p">[</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">facies</span></a> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">perm_min</span>  <span class="c1"># outside channels minimum</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a><span class="p">[</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">facies</span></a> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">perm_max</span>   <span class="c1"># inside channels maximum</span>

<span class="c1"># We use a model with 3 layers, starting all with the same permeability.</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.stack.html#numpy.stack" title="numpy.stack" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">stack</span></a><span class="p">([</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a><span class="p">]</span><span class="o">*</span><span class="n">nz</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 3x the same</span>

<span class="c1"># Assign true permeability (first) and prior permeability</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm_true</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a><span class="p">[:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm_prior</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
</pre></div>
</div>
</section>
<section id="plot-true-model">
<h2>Plot “true” model<a class="headerlink" href="#plot-true-model" title="Link to this heading">#</a></h2>
<p>The true permeability model is the one facies realization we use to create
observations by adding noise to the modelled data. These observations are
what we try to match with ESMDA. To look at this permeability field is
important to later interpret the result. In particular, we see that there is
a channel of high permeability connecting the injection with the production
well.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">fopts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sharex&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;sharey&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;constrained_layout&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<span class="n">popts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;vmin&quot;</span><span class="p">:</span> <span class="n">perm_min</span><span class="p">,</span> <span class="s2">&quot;vmax&quot;</span><span class="p">:</span> <span class="n">perm_max</span><span class="p">,</span> <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;lower&quot;</span><span class="p">}</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="o">**</span><span class="n">fopts</span><span class="p">)</span>

<span class="c1"># Permeabilities</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm_true</span></a><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">popts</span><span class="p">)</span>

<span class="c1"># Wells</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jw</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">iw</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>

<span class="c1"># Labels and colour bar</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Y Grid Cell&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;X Grid Cell&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
    <span class="s2">&quot;«True» Permeabilities (blue: injection, red: production well)&quot;</span>
<span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Permeability (mD)&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_geothermal_001.png" srcset="../_images/sphx_glr_geothermal_001.png" alt="«True» Permeabilities (blue: injection, red: production well)" class = "sphx-glr-single-img"/></section>
<section id="prior-permeabilities">
<h2>Prior permeabilities<a class="headerlink" href="#prior-permeabilities" title="Link to this heading">#</a></h2>
<p>Plot the first 12 prior permeability models; yellow shows the channels with
higher permeability.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">axs</span></a> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">fopts</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">axs</span></a><span class="o">.</span><span class="n">ravel</span><span class="p">()):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Realization </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Permeabilities</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm_prior</span></a><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">popts</span><span class="p">)</span>

    <span class="c1"># Wells</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jw</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">iw</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>

<span class="c1"># Labels and colour bar</span>
<span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="s2">&quot;Y Grid Cell&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s2">&quot;X Grid Cell&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
    <span class="s2">&quot;Prior Permeabilities with injection (blue) and production (red) wells&quot;</span>
<span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">axs</span></a><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Permeability (mD)&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_geothermal_002.png" srcset="../_images/sphx_glr_geothermal_002.png" alt="Prior Permeabilities with injection (blue) and production (red) wells, Realization 1, Realization 2, Realization 3, Realization 4, Realization 5, Realization 6, Realization 7, Realization 8, Realization 9, Realization 10, Realization 11, Realization 12" class = "sphx-glr-single-img"/></section>
<section id="darts-related-functionalities">
<h2>DARTS-related functionalities<a class="headerlink" href="#darts-related-functionalities" title="Link to this heading">#</a></h2>
<section id="custom-darts-model-class">
<h3>Custom DARTS Model class<a class="headerlink" href="#custom-darts-model-class" title="Link to this heading">#</a></h3>
<p>In the custom <code class="docutils literal notranslate"><span class="pre">Model</span></code> class for DARTS we define some fixed parameters
specific to this example.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">compute_darts</span><span class="p">:</span>

    <span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">DartsModel</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom DartsModel Class.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a><span class="p">,</span> <span class="n">n_points</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="o">=</span><span class="n">dz</span><span class="p">,</span>
                     <span class="n">iw</span><span class="o">=</span><span class="n">iw</span><span class="p">,</span> <span class="n">jw</span><span class="o">=</span><span class="n">jw</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Initialize a new DartsModel instance.&quot;&quot;&quot;</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="s2">&quot;initialization&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c1"># Parameters for the reservoir</span>
            <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a><span class="o">.</span><span class="n">shape</span>
            <span class="n">nb</span> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a><span class="o">.</span><span class="n">size</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">dx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">dy</span>
            <span class="n">dz</span> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ones.html#numpy.ones" title="numpy.ones" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">ones</span></a><span class="p">(</span><span class="n">nb</span><span class="p">)</span> <span class="o">*</span> <span class="n">dz</span>

            <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
            <span class="n">poro</span> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ones.html#numpy.ones" title="numpy.ones" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">ones</span></a><span class="p">(</span><span class="n">nb</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span>

            <span class="c1"># Discretize structured reservoir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span> <span class="o">=</span> <span class="n">StructReservoir</span><span class="p">(</span>
                <span class="n">timer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">,</span>
                <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span>
                <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span>
                <span class="n">nz</span><span class="o">=</span><span class="n">nz</span><span class="p">,</span>
                <span class="n">dx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span>
                <span class="n">dy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span>
                <span class="n">dz</span><span class="o">=</span><span class="n">dz</span><span class="p">,</span>
                <span class="n">permx</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a><span class="p">,</span>
                <span class="n">permy</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a><span class="p">,</span>
                <span class="n">permz</span><span class="o">=</span><span class="mf">0.1</span><span class="o">*</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a><span class="p">,</span>
                <span class="n">poro</span><span class="o">=</span><span class="n">poro</span><span class="p">,</span>
                <span class="n">depth</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
                <span class="n">hcap</span><span class="o">=</span><span class="mi">2200</span><span class="p">,</span>
                <span class="n">rcond</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Add open boundaries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">boundary_volumes</span><span class="p">[</span><span class="s2">&quot;yz_minus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e8</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">boundary_volumes</span><span class="p">[</span><span class="s2">&quot;yz_plus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e8</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">boundary_volumes</span><span class="p">[</span><span class="s2">&quot;xz_minus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e8</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">boundary_volumes</span><span class="p">[</span><span class="s2">&quot;xz_plus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e8</span>

            <span class="c1"># Add well locations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iw</span> <span class="o">=</span> <span class="n">iw</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jw</span> <span class="o">=</span> <span class="n">jw</span>

            <span class="c1"># Create pre-defined physics for geothermal</span>
            <span class="n">property_container</span> <span class="o">=</span> <span class="n">PropertyContainer</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">physics</span> <span class="o">=</span> <span class="n">Geothermal</span><span class="p">(</span>
                <span class="n">timer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">,</span>
                <span class="n">n_points</span><span class="o">=</span><span class="n">n_points</span><span class="p">,</span>
                <span class="n">min_p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">max_p</span><span class="o">=</span><span class="mi">351</span><span class="p">,</span>
                <span class="n">min_e</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                <span class="n">max_e</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">add_property_region</span><span class="p">(</span><span class="n">property_container</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">init_physics</span><span class="p">()</span>

            <span class="c1"># Timestep parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">first_ts</span> <span class="o">=</span> <span class="mf">1e-3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">mult_ts</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_ts</span> <span class="o">=</span> <span class="mi">365</span>

            <span class="c1"># Nonlinear and linear solver tolerance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">tolerance_newton</span> <span class="o">=</span> <span class="mf">1e-2</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="s2">&quot;initialization&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">set_wells</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Set well parameters.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">add_well</span><span class="p">(</span><span class="s2">&quot;INJ&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">nz</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">add_perforation</span><span class="p">(</span>
                    <span class="s2">&quot;INJ&quot;</span><span class="p">,</span>
                    <span class="n">cell_index</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">jw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">well_radius</span><span class="o">=</span><span class="mf">0.16</span><span class="p">,</span>
                    <span class="n">multi_segment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Add well</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">add_well</span><span class="p">(</span><span class="s2">&quot;PRD&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">nz</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">add_perforation</span><span class="p">(</span>
                    <span class="s2">&quot;PRD&quot;</span><span class="p">,</span>
                    <span class="n">cell_index</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iw</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">jw</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">well_radius</span><span class="o">=</span><span class="mf">0.16</span><span class="p">,</span>
                    <span class="n">multi_segment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">def</span> <span class="nf">set_initial_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Initialization with constant pressure and temperature.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">set_uniform_initial_conditions</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                <span class="n">uniform_pressure</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                <span class="n">uniform_temperature</span><span class="o">=</span><span class="mi">350</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">set_boundary_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Activate wells with rate control for injector and producer.&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">wells</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;INJ&quot;</span> <span class="ow">in</span> <span class="n">w</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">new_rate_water_inj</span><span class="p">(</span><span class="mi">4000</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">new_rate_water_prod</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="darts-simulation-function">
<h3>DARTS simulation function<a class="headerlink" href="#darts-simulation-function" title="Link to this heading">#</a></h3>
<p>In order to use an external code with <code class="docutils literal notranslate"><span class="pre">dageo</span></code>, you have to write a wrapper
function, which</p>
<ul class="simple">
<li><p>takes an ndarray of the shape of the prior models <code class="docutils literal notranslate"><span class="pre">(ne,</span> <span class="pre">...)</span></code>, and</p></li>
<li><p>returns an ndarray of the shape of the prior data <code class="docutils literal notranslate"><span class="pre">(ne,</span> <span class="pre">nd)</span></code>;</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">ne</span></code> is the number of ensembles, <code class="docutils literal notranslate"><span class="pre">nd</span></code> the number of data.</p>
<p>In this case using DARTS, the wrapper function is called
<code class="docutils literal notranslate"><span class="pre">temperature_at_production_well</span></code> and takes permeability fields as input,
and returns temperature (K) at production well as output.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">compute_darts</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">temperature_at_production_well</span><span class="p">(</span><span class="n">permeabilities</span><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">years</span></a><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">years</span></a><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;DARTS function predicting temperature at production well.&quot;&quot;&quot;</span>

        <span class="c1"># Pre-allocate output</span>
        <span class="n">temperature</span> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.zeros.html#numpy.zeros" title="numpy.zeros" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">zeros</span></a><span class="p">((</span><span class="n">permeabilities</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">years</span></a><span class="o">.</span><span class="n">size</span><span class="p">))</span>

        <span class="c1"># Loop over permeability fields</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">permeabilities</span><span class="p">):</span>

            <span class="c1"># Initialize a DARTS model for this permeability field</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm</span></a><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
            <span class="n">m</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">)</span>

            <span class="c1"># Run and store every year;</span>
            <span class="c1"># (in future DARTS versions the loop won&#39;t be needed).</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">years</span></a><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">365</span><span class="p">,</span> <span class="n">restart_dt</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>

            <span class="c1"># Store temperature</span>
            <span class="c1"># (Only taking the last nt samples, because sometimes the first</span>
            <span class="c1"># time step is cut and then repeated in the time_data; if you can</span>
            <span class="c1"># change the time_data to not report cut time-steps, then this may</span>
            <span class="c1"># not be necessary.)</span>
            <span class="n">temperature</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.array.html#numpy.array" title="numpy.array" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">array</span></a><span class="p">(</span>
                <span class="n">m</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">time_data</span><span class="p">[</span><span class="s2">&quot;PRD : temperature (K)&quot;</span><span class="p">]</span>
            <span class="p">)[</span><span class="o">-</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">years</span></a><span class="o">.</span><span class="n">size</span><span class="p">:]</span>

        <span class="k">return</span> <span class="n">temperature</span>
</pre></div>
</div>
</section>
</section>
<section id="simulate-prior-data">
<h2>Simulate prior data<a class="headerlink" href="#simulate-prior-data" title="Link to this heading">#</a></h2>
<p>Here we simulate “true” and prior data, and create “observed” data from
adding random noise to the true data.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">compute_darts</span><span class="p">:</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_true</span></a> <span class="o">=</span> <span class="n">temperature_at_production_well</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm_true</span></a><span class="p">)</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_prior</span></a> <span class="o">=</span> <span class="n">temperature_at_production_well</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm_prior</span></a><span class="p">)</span>
    <span class="c1"># Add noise to the true data and create observed data</span>
    <span class="n">dstd</span> <span class="o">=</span> <span class="mf">0.2</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_obs</span></a> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_true</span></a><span class="p">,</span> <span class="n">dstd</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_true</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.lib.npyio.NpzFile.html#numpy.lib.npyio.NpzFile" title="numpy.lib.npyio.NpzFile" class="sphx-glr-backref-module-numpy-lib-npyio sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">pc_darts</span></a><span class="p">[</span><span class="s2">&quot;data_true&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_prior</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.lib.npyio.NpzFile.html#numpy.lib.npyio.NpzFile" title="numpy.lib.npyio.NpzFile" class="sphx-glr-backref-module-numpy-lib-npyio sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">pc_darts</span></a><span class="p">[</span><span class="s2">&quot;data_prior&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_obs</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.lib.npyio.NpzFile.html#numpy.lib.npyio.NpzFile" title="numpy.lib.npyio.NpzFile" class="sphx-glr-backref-module-numpy-lib-npyio sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">pc_darts</span></a><span class="p">[</span><span class="s2">&quot;data_obs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>

<span class="n">k2c</span> <span class="o">=</span> <span class="o">-</span><span class="mf">273.15</span>  <span class="c1"># To plot °C instead of K</span>
</pre></div>
</div>
<section id="plot-prior-data">
<h3>Plot prior data<a class="headerlink" href="#plot-prior-data" title="Link to this heading">#</a></h3>
<p>The prior data show that there seem to be two possible clusters, one having
slightly higher temperatures than the other. The slightly colder cluster
corresponds to the models that have a connecting channel, the slightly warmer
cluster the models that have no connecting channel.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">years</span></a><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_obs</span></a><span class="o">+</span><span class="n">k2c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Observed&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">years</span></a><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_prior</span><span class="o">.</span><span class="n">T</span></a><span class="o">+</span><span class="n">k2c</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Prior&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ne</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (years)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Temperature (°C)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Temperature at Production Well&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_geothermal_003.png" srcset="../_images/sphx_glr_geothermal_003.png" alt="Temperature at Production Well" class = "sphx-glr-single-img"/></section>
</section>
<section id="perform-data-assimilation-esmda">
<h2>Perform Data Assimilation (ESMDA)<a class="headerlink" href="#perform-data-assimilation-esmda" title="Link to this heading">#</a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a function to restrict the permeability values</span>
<span class="k">def</span> <span class="nf">restrict_permeability</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Restrict possible permeabilities.&quot;&quot;&quot;</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.clip.html#numpy.clip" title="numpy.clip" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">clip</span></a><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">perm_min</span><span class="p">,</span> <span class="n">perm_max</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>


<span class="c1"># Run ESMDA</span>
<span class="k">if</span> <span class="n">compute_darts</span><span class="p">:</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm_post</span></a><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_post</span></a> <span class="o">=</span> <span class="n">dageo</span><span class="o">.</span><span class="n">esmda</span><span class="p">(</span>
        <span class="n">model_prior</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm_prior</span></a><span class="p">,</span>
        <span class="n">forward</span><span class="o">=</span><span class="n">temperature_at_production_well</span><span class="p">,</span>
        <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_obs</span></a><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_obs</span></a><span class="p">,</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">dstd</span><span class="p">,</span>
        <span class="n">alphas</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_prior</span></a><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_prior</span></a><span class="p">,</span>
        <span class="n">callback_post</span><span class="o">=</span><span class="n">restrict_permeability</span><span class="p">,</span>
        <span class="n">random</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Store result</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.savez_compressed.html#numpy.savez_compressed" title="numpy.savez_compressed" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">savez_compressed</span></a><span class="p">(</span>
        <span class="n">file</span><span class="o">=</span><span class="s2">&quot;darts_output_geothermal.npz&quot;</span><span class="p">,</span>
        <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_true</span></a><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_true</span></a><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">),</span>
        <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_obs</span></a><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_obs</span></a><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">),</span>
        <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_prior</span></a><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_prior</span></a><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">),</span>
        <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_post</span></a><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_post</span></a><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">),</span>
        <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm_post</span></a><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm_post</span></a><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">),</span>
        <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_post</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.lib.npyio.NpzFile.html#numpy.lib.npyio.NpzFile" title="numpy.lib.npyio.NpzFile" class="sphx-glr-backref-module-numpy-lib-npyio sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">pc_darts</span></a><span class="p">[</span><span class="s2">&quot;data_post&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm_post</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.lib.npyio.NpzFile.html#numpy.lib.npyio.NpzFile" title="numpy.lib.npyio.NpzFile" class="sphx-glr-backref-module-numpy-lib-npyio sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">pc_darts</span></a><span class="p">[</span><span class="s2">&quot;perm_post&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>
</pre></div>
</div>
<section id="plot-posterior-data">
<h3>Plot posterior data<a class="headerlink" href="#plot-posterior-data" title="Link to this heading">#</a></h3>
<p>Models that connect the injection and production well with higher
permeability (lower temperature) are the ones which match the data better.
Even when we originally did not have channels between the injection and
production well, the model found that the best way to match the data is to
increase the permeability between the wells.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">years</span></a><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_obs</span></a><span class="o">+</span><span class="n">k2c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Observed&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">years</span></a><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_prior</span><span class="o">.</span><span class="n">T</span></a><span class="o">+</span><span class="n">k2c</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Prior&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ne</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">years</span></a><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data_post</span><span class="o">.</span><span class="n">T</span></a><span class="o">+</span><span class="n">k2c</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Posterior&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ne</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (years)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Temperature (°C)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Temperature at Production Well&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_geothermal_004.png" srcset="../_images/sphx_glr_geothermal_004.png" alt="Temperature at Production Well" class = "sphx-glr-single-img"/></section>
<section id="plot-posterior-permeabilities">
<h3>Plot posterior permeabilities<a class="headerlink" href="#plot-posterior-permeabilities" title="Link to this heading">#</a></h3>
<p>Plot the first 12 posterior permeability models.</p>
<p>The data is matched nicely (above figure), yet we still have different
realizations, meaning that the posterior does not look like the “true” model,
as expected (ill-posed problem). This means that we still have uncertainty in
the model, and also that the ensemble has not collapsed to a single model.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">axs</span></a> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">fopts</span><span class="p">)</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">axs</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">axs</span></a><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ne</span><span class="p">,</span> <span class="mi">12</span><span class="p">)):</span>
    <span class="n">im</span> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">axs</span></a><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm_post</span></a><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">popts</span><span class="p">)</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">axs</span></a><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">axs</span></a><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jw</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">iw</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">axs</span></a><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Permeability (mD)&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
    <span class="s2">&quot;Posterior Permeabilities with injection (blue) and production (red) wells&quot;</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="s2">&quot;Y Grid Cell&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s2">&quot;X Grid Cell&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_geothermal_005.png" srcset="../_images/sphx_glr_geothermal_005.png" alt="Posterior Permeabilities with injection (blue) and production (red) wells" class = "sphx-glr-single-img"/></section>
<section id="plot-permeability-differences">
<h3>Plot permeability differences<a class="headerlink" href="#plot-permeability-differences" title="Link to this heading">#</a></h3>
<p>The difference between prior and posterior shows nicely that in models, where
there is a channel between the injection and production well, not much had to
change in terms of permeability to predict the data. In models, however,
where there is no connecting channel, it increased significantly the
permeability between the wells, and decreased them further out.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">popts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;vmin&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;vmax&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;cmap&quot;</span><span class="p">:</span> <span class="s2">&quot;RdBu&quot;</span><span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">axs</span></a> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">fopts</span><span class="p">)</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">axs</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">axs</span></a><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ne</span><span class="p">,</span> <span class="mi">12</span><span class="p">)):</span>
    <span class="n">im</span> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">axs</span></a><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm_post</span></a><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">perm_prior</span></a><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">popts</span><span class="p">)</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">axs</span></a><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">axs</span></a><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jw</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">iw</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">axs</span></a><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Permeability difference (mD)&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
    <span class="s2">&quot;Permeability differences (black injection, white production well)&quot;</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="s2">&quot;Y Grid Cell&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s2">&quot;X Grid Cell&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_geothermal_006.png" srcset="../_images/sphx_glr_geothermal_006.png" alt="Permeability differences (black injection, white production well)" class = "sphx-glr-single-img"/></section>
</section>
<section id="reproduce-the-facies">
<h2>Reproduce the facies<a class="headerlink" href="#reproduce-the-facies" title="Link to this heading">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The following cell is about how to reproduce the facies data loaded in
<code class="docutils literal notranslate"><span class="pre">facies_geothermal.nc</span></code>. This was created using <code class="docutils literal notranslate"><span class="pre">geomodpy</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">geomodpy</span></code> (Guillaume Rongier, 2023) is not open-source yet. The
functionality of geomodpy that we use here is a python wrapper for the
Fortran library <code class="docutils literal notranslate"><span class="pre">FLUVSIM</span></code> published in:</p>
<blockquote>
<div><p><strong>Deutsch, C. V., and T. T. Tran</strong>, 2002, FLUVSIM: a program for
object-based stochastic modeling of fluvial depositional systems:
Computers &amp; Geosciences, 28(4), 525–535.</p>
<p>DOI: <a class="reference external" href="https://doi.org/10.1016/S0098-3004(01)00075-9">10.1016/S0098-3004(01)00075-9</a>.</p>
</div></blockquote>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># FLUVSIM Version used: 2.900</span>
<span class="kn">from</span> <span class="nn">geomodpy.wrapper.fluvsim</span> <span class="kn">import</span> <span class="n">FLUVSIM</span>

<span class="c1"># Dimensions</span>
<span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span>
<span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span>
<span class="n">ne</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># Create a fluvsim instance with the geological parameters</span>
<span class="n">fluvsim</span> <span class="o">=</span> <span class="n">FLUVSIM</span><span class="p">(</span>
    <span class="n">channel_orientation</span><span class="o">=</span><span class="p">(</span><span class="mf">60.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">,</span> <span class="mf">120.</span><span class="p">),</span>
    <span class="c1"># Proportions for each facies</span>
    <span class="n">channel_prop</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">crevasse_prop</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">levee_prop</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="c1"># Parameters defining the grid</span>
    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span>
    <span class="n">spacing</span><span class="o">=</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">),</span>
    <span class="n">origin</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="c1"># Number of realizations and random seed</span>
    <span class="n">n_realizations</span><span class="o">=</span><span class="n">ne</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># +1 for &quot;true&quot;</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Run fluvsim to create the facies</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">facies</span></a> <span class="o">=</span> <span class="n">fluvsim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">facies</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">facies</span></a><span class="o">.</span><span class="n">data_vars</span><span class="p">[</span><span class="s2">&quot;facies code&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;i4&quot;</span><span class="p">)</span>

<span class="c1"># Save the facies values as a compressed npy-file.</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;facies_geothermal.npy&quot;</span><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">facies</span></a><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">dageo</span><span class="o">.</span><span class="n">Report</span><span class="p">()</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<table style='border: 1.5px solid;'>
  <tr>
     <td style='text-align: center; font-weight: bold; font-size: 1.2em; border: 1px solid;' colspan='6'>Fri Dec 06 15:58:59 2024 UTC</td>
  </tr>
  <tr>
    <td style='text-align: right; border: 1px solid;'>OS</td>
    <td style='text-align: left; border: 1px solid;'>Linux (Ubuntu 22.04)</td>
    <td style='text-align: right; border: 1px solid;'>CPU(s)</td>
    <td style='text-align: left; border: 1px solid;'>4</td>
    <td style='text-align: right; border: 1px solid;'>Machine</td>
    <td style='text-align: left; border: 1px solid;'>x86_64</td>
  </tr>
  <tr>
    <td style='text-align: right; border: 1px solid;'>Architecture</td>
    <td style='text-align: left; border: 1px solid;'>64bit</td>
    <td style='text-align: right; border: 1px solid;'>RAM</td>
    <td style='text-align: left; border: 1px solid;'>15.6 GiB</td>
    <td style='text-align: right; border: 1px solid;'>Environment</td>
    <td style='text-align: left; border: 1px solid;'>Python</td>
  </tr>
  <tr>
    <td style='text-align: right; border: 1px solid;'>File system</td>
    <td style='text-align: left; border: 1px solid;'>ext4</td>
  </tr>
  <tr>
     <td style='text-align: center; border: 1px solid;' colspan='6'>Python 3.12.7 (main, Oct  1 2024, 15:17:55) [GCC 11.4.0]</td>
  </tr>
  <tr>
    <td style='text-align: right; border: 1px solid;'>dageo</td>
    <td style='text-align: left; border: 1px solid;'>1.1.0</td>
    <td style='text-align: right; border: 1px solid;'>numpy</td>
    <td style='text-align: left; border: 1px solid;'>2.1.3</td>
    <td style='text-align: right; border: 1px solid;'>scipy</td>
    <td style='text-align: left; border: 1px solid;'>1.14.1</td>
  </tr>
  <tr>
    <td style='text-align: right; border: 1px solid;'>matplotlib</td>
    <td style='text-align: left; border: 1px solid;'>3.9.3</td>
    <td style='text-align: right; border: 1px solid;'>IPython</td>
    <td style='text-align: left; border: 1px solid;'>8.30.0</td>
    <td style= border: 1px solid;'></td>
    <td style= border: 1px solid;'></td>
  </tr>
</table>
</div>
<br />
<br /><p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 5.403 seconds)</p>
<p><strong>Estimated memory usage:</strong>  137 MB</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-gallery-geothermal-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/8863c1bfc4694f6d367d7552cc0db191/geothermal.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">geothermal.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/0021fc60f364f6e99bd7a8488efcedd7/geothermal.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">geothermal.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../_downloads/bc48daf5a0972da9a28e335d9cda60a6/geothermal.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">geothermal.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="fluvialreservoir.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">2D Fluvial Reservoir ESMDA example</p>
      </div>
    </a>
    <a class="right-next"
       href="localization.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Localization</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pre-computed-data">Pre-computed data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#darts-computation">DARTS computation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fluvial-models">Fluvial models</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-pre-computed-data">Load pre-computed data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#convert-facies-to-permeability">Convert facies to permeability</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-true-model">Plot “true” model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prior-permeabilities">Prior permeabilities</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#darts-related-functionalities">DARTS-related functionalities</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-darts-model-class">Custom DARTS Model class</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#darts-simulation-function">DARTS simulation function</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simulate-prior-data">Simulate prior data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-prior-data">Plot prior data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#perform-data-assimilation-esmda">Perform Data Assimilation (ESMDA)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-posterior-data">Plot posterior data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-posterior-permeabilities">Plot posterior permeabilities</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-permeability-differences">Plot permeability differences</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reproduce-the-facies">Reproduce the facies</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/gallery/geothermal.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024-2024, D. Werthmüller, G. Serrao Seabra, F.C. Vossepoel.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.0.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>